# ===========================================================================
# DOCKER DEPLOYMENT PIPELINE
# Handles Docker Compose service deployments across hosts
# ===========================================================================

.docker_base:
  image: alpine:latest
  tags:
    - docker
  before_script:
    - apk add --no-cache openssh-client rsync git
    - mkdir -p ~/.ssh
    - base64 -d $CI_PROJECT_DIR/.ssh/one_key.b64 > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - |
      if ! ssh-keygen -y -P "" -f ~/.ssh/id_ed25519 > /dev/null 2>&1; then
        echo "ERROR: Invalid or corrupted SSH key"
        exit 1
      fi

# ===========================================================================
# VALIDATION
# ===========================================================================

validate_docker_compose:
  extends: .docker_base
  stage: validate
  rules:
    - changes:
        - docker/**/*
      when: on_success
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Validating Docker Compose Changes"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^docker/' || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No Docker changes detected"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      
      # Check for Renovate updates
      if echo "$CI_COMMIT_MESSAGE" | grep -qi "renovate\|dependencies\|chore(deps)"; then
        echo ""
        echo "RENOVATE UPDATE DETECTED"
        echo "------------------------------------------------"
        
        if echo "$CHANGED" | grep -q ".env"; then
          echo "Version updates detected in .env files:"
          for envfile in $(echo "$CHANGED" | grep ".env"); do
            echo "  - $envfile"
            git diff-tree --no-commit-id -p -r HEAD -- "$envfile" | grep "^[+-].*_VERSION" || true
          done
          echo ""
          
          # Check for major version updates
          if git diff-tree --no-commit-id -p -r HEAD | grep "^+.*_VERSION" | grep -qE "v?[0-9]+\.0\.0|^[0-9]+\.0\.0"; then
            echo "WARNING: Major version update detected!"
            echo "Review changelog before deploying!"
            echo ""
          fi
        fi
      fi
      
      # Validate compose files exist
      VALIDATION_FAILED=0
      
      for file in $CHANGED; do
        if echo "$file" | grep -q "compose.ya\?ml"; then
          echo "Checking: $file"
          
          if [ ! -f "$CI_PROJECT_DIR/$file" ]; then
            echo "  ERROR: File not found"
            VALIDATION_FAILED=1
            continue
          fi
          
          # Basic YAML syntax check
          if ! python3 -c "import yaml; yaml.safe_load(open('$CI_PROJECT_DIR/$file'))" 2>/dev/null; then
            echo "  ERROR: Invalid YAML syntax"
            VALIDATION_FAILED=1
            continue
          fi
          
          echo "  PASS: Valid compose file"
        fi
      done
      
      if [ $VALIDATION_FAILED -eq 1 ]; then
        echo ""
        echo "ERROR: Validation failed"
        exit 1
      fi
      
      echo ""
      echo "SUCCESS: All validations passed"
  allow_failure: false

# ===========================================================================
# DEPLOYMENT
# ===========================================================================

deploy_docker:
  extends: .docker_base
  stage: deploy
  rules:
    - changes:
        - docker/**/*
      when: on_success
    - if: '$CI_MERGE_REQUEST_LABELS =~ /renovate/'
      when: manual
      allow_failure: true
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  needs:
    - validate_docker_compose
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Docker Deployment"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^docker/' || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No changes detected in docker/ directory"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      echo ""
      
      # Renovate notification
      if echo "$CI_COMMIT_MESSAGE" | grep -qi "renovate\|dependencies\|chore(deps)"; then
        echo "RENOVATE UPDATE - Automated dependency update"
        echo ""
      fi
      
      DEPLOYMENT_FAILED=0
      
      for file in $CHANGED; do
        HOST=$(echo "$file" | cut -d'/' -f2)
        PROJECT=$(echo "$file" | cut -d'/' -f3)
        
        echo "========================================"
        echo "Deploying $PROJECT to $HOST"
        echo "========================================"
        
        # Add host to known_hosts
        ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Validate SSH connection
        echo "Validating SSH connection to $HOST..."
        if ! ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
             root@"$HOST" "echo 'connected'" &>/dev/null; then
          echo "ERROR: Cannot connect to $HOST"
          DEPLOYMENT_FAILED=1
          continue
        fi
        echo "  Connection validated"
        
        # Rsync project files
        echo "Syncing files to $HOST:/srv/$PROJECT/..."
        if ! rsync -avz \
          -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
          "$CI_PROJECT_DIR/docker/$HOST/$PROJECT/" \
          "root@$HOST:/srv/$PROJECT/"; then
          echo "ERROR: Failed to sync files to $HOST"
          DEPLOYMENT_FAILED=1
          continue
        fi
        
        # Deploy with docker compose
        echo "Running docker compose on $HOST..."
        if ! ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
             root@"$HOST" \
             "cd /srv/$PROJECT && docker compose pull && docker compose up -d --remove-orphans"; then
          echo "ERROR: Docker compose failed on $HOST"
          DEPLOYMENT_FAILED=1
          continue
        fi
        
        echo "SUCCESS: $PROJECT deployed to $HOST"
        echo ""
      done
      
      if [ $DEPLOYMENT_FAILED -eq 1 ]; then
        echo "================================================"
        echo "ERROR: One or more deployments failed"
        echo "================================================"
        exit 1
      fi
      
      echo "================================================"
      echo "SUCCESS: Docker deployment completed"
      echo "================================================"
  environment: production

# ===========================================================================
# POST-DEPLOYMENT VERIFICATION
# ===========================================================================

verify_docker_deployments:
  extends: .docker_base
  stage: verify
  rules:
    - changes:
        - docker/**/*
      when: on_success
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  needs:
    - deploy_docker
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Docker Deployment Verification"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^docker/' || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No changes to verify"
        exit 0
      fi
      
      echo "Waiting 10 seconds for containers to stabilize..."
      sleep 10
      
      VERIFICATION_FAILED=0
      
      for file in $CHANGED; do
        HOST=$(echo "$file" | cut -d'/' -f2)
        PROJECT=$(echo "$file" | cut -d'/' -f3)
        
        echo ""
        echo "Verifying $PROJECT on $HOST..."
        
        ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Check container status
        CONTAINER_STATUS=$(ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
          root@"$HOST" \
          "cd /srv/$PROJECT && docker compose ps --format '{{.Service}}: {{.State}}'" || echo "ERROR")
        
        if [ "$CONTAINER_STATUS" = "ERROR" ]; then
          echo "  ERROR: Could not get container status"
          VERIFICATION_FAILED=1
          continue
        fi
        
        echo "$CONTAINER_STATUS" | while read line; do
          echo "  $line"
        done
        
        # Check for unhealthy containers
        if echo "$CONTAINER_STATUS" | grep -qi "exited\|restarting\|dead"; then
          echo "  WARNING: Some containers not running properly"
          VERIFICATION_FAILED=1
        else
          echo "  PASS: All containers running"
        fi
      done
      
      if [ $VERIFICATION_FAILED -eq 1 ]; then
        echo ""
        echo "WARNING: Some verifications failed"
        echo "Check container logs for details"
      else
        echo ""
        echo "SUCCESS: All deployments verified"
      fi
  artifacts:
    when: always
    expire_in: 7 days
  allow_failure: true
