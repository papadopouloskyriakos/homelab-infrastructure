# ===========================================================================
# DOCKER DEPLOYMENT PIPELINE
# Handles Docker Compose service deployments across hosts
# ===========================================================================
# Structure: docker/<hostname>/<path>/<to>/<project>/docker-compose.yml
# Deploys to: /srv/<path>/<to>/<project>/ on <hostname>
# ===========================================================================

.docker_base:
  image: $DOCKER_IMAGE
  tags:
    - docker
  before_script:
    - mkdir -p ~/.ssh
    - base64 -d $CI_PROJECT_DIR/.ssh/one_key.b64 > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - |
      if ! ssh-keygen -y -P "" -f ~/.ssh/id_ed25519 > /dev/null 2>&1; then
        echo "ERROR: Invalid or corrupted SSH key"
        exit 1
      fi

# ===========================================================================
# VALIDATION
# ===========================================================================

validate_docker_compose:
  extends: .docker_base
  stage: validate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        paths:
          - docker/**/*
        compare_to: 'refs/heads/main'
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Validating Docker Compose Changes"
      echo "================================================"
      
      if [ -n "${CI_MERGE_REQUEST_TARGET_BRANCH_SHA:-}" ]; then
        CHANGED=$(git diff --name-only "$CI_MERGE_REQUEST_TARGET_BRANCH_SHA" HEAD | grep '^docker/' || true)
      else
        CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^docker/' || true)
      fi
      
      if [ -z "$CHANGED" ]; then
        echo "No Docker changes detected"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      
      if echo "$CI_COMMIT_MESSAGE" | grep -qi "renovate\|dependencies\|chore(deps)"; then
        echo ""
        echo "RENOVATE UPDATE DETECTED"
        echo "------------------------------------------------"
      fi
      
      VALIDATION_FAILED=0
      for file in $CHANGED; do
        if echo "$file" | grep -q "compose.ya\?ml"; then
          echo "Checking: $file"
          if [ ! -f "$CI_PROJECT_DIR/$file" ]; then
            echo "  ERROR: File not found"
            VALIDATION_FAILED=1
            continue
          fi
          if ! python3 -c "import yaml; yaml.safe_load(open('$CI_PROJECT_DIR/$file'))" 2>/dev/null; then
            echo "  ERROR: Invalid YAML syntax"
            VALIDATION_FAILED=1
            continue
          fi
          echo "  PASS: Valid compose file"
        fi
      done
      
      if [ $VALIDATION_FAILED -eq 1 ]; then
        echo ""
        echo "ERROR: Validation failed"
        exit 1
      fi
      
      echo ""
      echo "SUCCESS: All validations passed"
  allow_failure: false

# ===========================================================================
# DEPLOYMENT
# ===========================================================================

deploy_docker:
  extends: .docker_base
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - docker/**/*
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Docker Deployment"
      echo "================================================"
      
      if git rev-parse HEAD^2 >/dev/null 2>&1; then
        CHANGED=$(git diff --name-only HEAD^1 HEAD | grep '^docker/' || true)
        echo "Merge commit detected - comparing merged changes"
      else
        CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^docker/' || true)
      fi
      
      if [ -z "$CHANGED" ]; then
        echo "No changes detected in docker/ directory"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      echo ""
      
      if echo "$CI_COMMIT_MESSAGE" | grep -qi "renovate\|dependencies\|chore(deps)"; then
        echo "RENOVATE UPDATE - Automated dependency update"
        echo ""
      fi
      
      PROJECTS=""
      for file in $CHANGED; do
        DIR=$(dirname "$file")
        while [ "$DIR" != "docker" ] && [ "$DIR" != "." ]; do
          if [ -f "$CI_PROJECT_DIR/$DIR/docker-compose.yml" ] || \
             [ -f "$CI_PROJECT_DIR/$DIR/docker-compose.yaml" ] || \
             [ -f "$CI_PROJECT_DIR/$DIR/Dockerfile" ]; then
            PROJECTS="$PROJECTS $DIR"
            break
          fi
          DIR=$(dirname "$DIR")
        done
      done
      
      PROJECTS=$(echo "$PROJECTS" | tr ' ' '\n' | grep -v '^$' | sort -u)
      
      if [ -z "$PROJECTS" ]; then
        echo "No docker-compose.yml or Dockerfile found in changed directories"
        exit 0
      fi
      
      echo "Projects to deploy:"
      echo "$PROJECTS" | sed 's/^/  /'
      echo ""
      
      DEPLOYMENT_FAILED=0
      
      for project_path in $PROJECTS; do
        HOST=$(echo "$project_path" | cut -d'/' -f2)
        DEPLOY_SUBPATH=$(echo "$project_path" | sed "s|^docker/$HOST/||")
        DEPLOY_PATH="/srv/$DEPLOY_SUBPATH"
        
        echo "========================================"
        echo "Deploying to $HOST:$DEPLOY_PATH"
        echo "========================================"
        
        ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "Validating SSH connection to $HOST..."
        if ! ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
             root@"$HOST" "echo 'connected'" &>/dev/null; then
          echo "ERROR: Cannot connect to $HOST"
          DEPLOYMENT_FAILED=1
          continue
        fi
        echo "  Connection validated"
        
        ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            root@"$HOST" "mkdir -p $DEPLOY_PATH"
        
        echo "Syncing files to $HOST:$DEPLOY_PATH/..."
        if ! rsync -avz \
          -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
          "$CI_PROJECT_DIR/$project_path/" \
          "root@$HOST:$DEPLOY_PATH/"; then
          echo "ERROR: Failed to sync files to $HOST"
          DEPLOYMENT_FAILED=1
          continue
        fi
        
        PROJECT_CHANGED=$(echo "$CHANGED" | grep "^$project_path/" || true)
        NEEDS_BUILD=0
        if echo "$PROJECT_CHANGED" | grep -q "Dockerfile"; then
          NEEDS_BUILD=1
          echo "  Dockerfile changed - will build image"
        fi
        
        HAS_COMPOSE=0
        if [ -f "$CI_PROJECT_DIR/$project_path/docker-compose.yml" ] || \
           [ -f "$CI_PROJECT_DIR/$project_path/docker-compose.yaml" ]; then
          HAS_COMPOSE=1
        fi
        
        echo "Running docker compose on $HOST..."
        if [ "$HAS_COMPOSE" -eq 1 ]; then
          if [ "$NEEDS_BUILD" -eq 1 ]; then
            if ! ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                 root@"$HOST" \
                 "cd $DEPLOY_PATH && docker compose build --no-cache && docker compose up -d --remove-orphans"; then
              echo "ERROR: Docker compose build/up failed on $HOST"
              DEPLOYMENT_FAILED=1
              continue
            fi
          else
            if ! ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                 root@"$HOST" \
                 "cd $DEPLOY_PATH && docker compose pull && docker compose up -d --remove-orphans"; then
              echo "ERROR: Docker compose pull/up failed on $HOST"
              DEPLOYMENT_FAILED=1
              continue
            fi
          fi
        else
          echo "  No docker-compose.yml found, building image only..."
          IMGNAME=$(basename "$DEPLOY_PATH")
          if ! ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
               root@"$HOST" \
               "cd $DEPLOY_PATH && docker build -t $IMGNAME:latest ."; then
            echo "ERROR: Docker build failed on $HOST"
            DEPLOYMENT_FAILED=1
            continue
          fi
        fi
        
        echo "SUCCESS: Deployed to $HOST:$DEPLOY_PATH"
        echo ""
      done
      
      if [ $DEPLOYMENT_FAILED -eq 1 ]; then
        echo "================================================"
        echo "ERROR: One or more deployments failed"
        echo "================================================"
        exit 1
      fi
      
      echo "================================================"
      echo "SUCCESS: Docker deployment completed"
      echo "================================================"
  environment: production

# ===========================================================================
# POST-DEPLOYMENT VERIFICATION
# ===========================================================================

verify_docker_deployments:
  extends: .docker_base
  stage: verify
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - docker/**/*
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  needs:
    - deploy_docker
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Docker Deployment Verification"
      echo "================================================"
      
      if git rev-parse HEAD^2 >/dev/null 2>&1; then
        CHANGED=$(git diff --name-only HEAD^1 HEAD | grep '^docker/' || true)
      else
        CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^docker/' || true)
      fi
      
      if [ -z "$CHANGED" ]; then
        echo "No changes to verify"
        exit 0
      fi
      
      echo "Waiting 10 seconds for containers to stabilize..."
      sleep 10
      
      PROJECTS=""
      for file in $CHANGED; do
        DIR=$(dirname "$file")
        while [ "$DIR" != "docker" ] && [ "$DIR" != "." ]; do
          if [ -f "$CI_PROJECT_DIR/$DIR/docker-compose.yml" ] || \
             [ -f "$CI_PROJECT_DIR/$DIR/docker-compose.yaml" ] || \
             [ -f "$CI_PROJECT_DIR/$DIR/Dockerfile" ]; then
            PROJECTS="$PROJECTS $DIR"
            break
          fi
          DIR=$(dirname "$DIR")
        done
      done
      
      PROJECTS=$(echo "$PROJECTS" | tr ' ' '\n' | grep -v '^$' | sort -u)
      
      if [ -z "$PROJECTS" ]; then
        echo "No projects to verify"
        exit 0
      fi
      
      VERIFICATION_FAILED=0
      
      for project_path in $PROJECTS; do
        HOST=$(echo "$project_path" | cut -d'/' -f2)
        DEPLOY_SUBPATH=$(echo "$project_path" | sed "s|^docker/$HOST/||")
        DEPLOY_PATH="/srv/$DEPLOY_SUBPATH"
        
        echo ""
        echo "Verifying $DEPLOY_PATH on $HOST..."
        
        ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
        
        if [ -f "$CI_PROJECT_DIR/$project_path/docker-compose.yml" ] || \
           [ -f "$CI_PROJECT_DIR/$project_path/docker-compose.yaml" ]; then
          CONTAINER_STATUS=$(ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            root@"$HOST" \
            "cd $DEPLOY_PATH && docker compose ps --format '{{.Service}}: {{.State}}'" 2>/dev/null || echo "ERROR")
          
          if [ "$CONTAINER_STATUS" = "ERROR" ]; then
            echo "  ERROR: Could not get container status"
            VERIFICATION_FAILED=1
            continue
          fi
          
          echo "$CONTAINER_STATUS" | while read line; do
            echo "  $line"
          done
          
          if echo "$CONTAINER_STATUS" | grep -qi "exited\|restarting\|dead"; then
            echo "  WARNING: Some containers not running properly"
            VERIFICATION_FAILED=1
          else
            echo "  PASS: All containers running"
          fi
        else
          echo "  SKIP: No docker-compose.yml (image-only build)"
        fi
      done
      
      if [ $VERIFICATION_FAILED -eq 1 ]; then
        echo ""
        echo "WARNING: Some verifications failed"
        echo "Check container logs for details"
      else
        echo ""
        echo "SUCCESS: All deployments verified"
      fi
  artifacts:
    when: always
    expire_in: 7 days
  allow_failure: true