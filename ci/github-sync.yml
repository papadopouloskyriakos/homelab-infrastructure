# ===========================================================================
# GITHUB PUBLIC MIRROR PIPELINE
# Sanitizes and syncs selected content to public GitHub repository
# ===========================================================================
# Uses: github-sync-runner image with pre-installed tools
# Triggers: Manual or scheduled
# Target: github.com/$GITHUB_REPO
# ===========================================================================

variables:
  GITHUB_SYNC_IMAGE: "registry.example.net/infrastructure/nl/production/github-sync-runner:latest"

.github_sync_base:
  image: $GITHUB_SYNC_IMAGE
  tags:
    - docker
  variables:
    GIT_STRATEGY: none

# ===========================================================================
# SYNC TO GITHUB
# ===========================================================================

sync_to_github:
  extends: .github_sync_base
  needs: []
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "web"'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - when: never
  script:
    - |
      set -e
      echo "================================================"
      echo "GitHub Public Mirror - Sanitization Sync"
      echo "================================================"
      echo "Source: ${CI_REPOSITORY_URL}"
      echo "Target: github.com/${GITHUB_REPO}"
      echo "================================================"
      
      echo "[1/5] Cloning source repository..."
      git clone "${CI_REPOSITORY_URL}" repo
      cd repo
      
      echo "[2/5] Filtering to public paths..."
      git filter-repo --force \
        --path README.md \
        --path LICENSE \
        --path atlantis.yaml \
        --path renovate.json \
        --path k8s/ \
        --path network/configs/ \
        --path network/scripts/ \
        --path ansible/playbooks/ \
        --path ci/
      
      echo "[3/5] Sanitizing content..."
      cat > /tmp/replacements.txt << 'EOF'
      nl==>nl
      gr==>gr
      gitlab.example.net==>gitlab.example.net
      registry.example.net==>registry.example.net
      api-k8s.example.net==>api-k8s.example.net
      regex:192\.168\.\d{1,3}\.\d{1,3}==>10.0.X.X
      EOF
      git filter-repo --force --replace-text /tmp/replacements.txt
      
      echo "[4/5] Reorganizing structure..."
      git filter-repo --force --path-rename k8s/:kubernetes/
      
      echo "[5/5] Pushing to GitHub..."
      git remote add github "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git"
      git push github main --force
      
      echo "================================================"
      echo "SUCCESS: https://github.com/${GITHUB_REPO}"
      echo "================================================"
  environment:
    name: github-public
    url: https://github.com/$GITHUB_REPO

# ===========================================================================
# DRY RUN - Test without pushing
# ===========================================================================

github_sync_dry_run:
  extends: .github_sync_base
  stage: validate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - k8s/**/*
        - network/**/*
        - docker/**/*
        - ansible/**/*
      when: manual
      allow_failure: true
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
  script:
    - |
      echo "================================================"
      echo "GitHub Sync - DRY RUN"
      echo "================================================"
      
      /usr/local/share/github-sync/sync-to-github.sh --dry-run --verbose

# ===========================================================================
# SECRETS SCAN ONLY - Quick check without sync
# ===========================================================================

github_sync_scan_only:
  extends: .github_sync_base
  stage: validate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
  script:
    - |
      echo "================================================"
      echo "Secrets Scan Only"
      echo "================================================"
      
      # Clone and filter, then scan (no push)
      git clone --mirror "${CI_REPOSITORY_URL}" repo.git
      cd repo.git
      git checkout main
      
      # Filter to public paths
      git filter-repo --force \
        --path README.md \
        --path k8s/ \
        --path network/ \
        --path ansible/ \
        --path ci/ \
        --path docker/
      
      # Apply sanitization
      git filter-repo --force --replace-text /etc/github-sync/replacements.txt
      
      # Run comprehensive scan
      /usr/local/share/github-sync/scan-secrets.sh .
      
      echo ""
      echo "Scan complete - check output above"

# ===========================================================================
# BUILD THE RUNNER IMAGE
# ===========================================================================

build_github_sync_runner:
  stage: .pre
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - docker/nlgitlab01/github-sync-runner/**/*
      when: manual
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      cd docker/nlgitlab01/github-sync-runner
      docker build -t $GITHUB_SYNC_IMAGE .
      docker push $GITHUB_SYNC_IMAGE
  environment:
    name: docker-registry
