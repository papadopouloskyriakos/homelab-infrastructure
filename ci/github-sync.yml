# ===========================================================================
# GITHUB PUBLIC MIRROR PIPELINE
# Sanitizes and syncs selected content to public GitHub repository
# ===========================================================================
# Uses: github-sync-runner image with pre-installed tools
# Triggers: On every push to main
# Target: github.com/$GITHUB_REPO
# ===========================================================================

variables:
  GITHUB_SYNC_IMAGE: "registry.example.net/infrastructure/nl/production/github-sync-runner:latest"

.github_sync_base:
  image: $GITHUB_SYNC_IMAGE
  tags:
    - docker
  variables:
    GIT_STRATEGY: none

# ===========================================================================
# SYNC TO GITHUB
# ===========================================================================

sync_to_github:
  extends: .github_sync_base
  needs: []
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - |
      set -e
      echo "================================================"
      echo "GitHub Public Mirror - Sanitization Sync"
      echo "================================================"
      echo "Source: ${CI_REPOSITORY_URL}"
      echo "Target: github.com/${GITHUB_REPO}"
      echo "================================================"
      
      echo "[1/7] Cloning source repository..."
      git clone "${CI_REPOSITORY_URL}" repo
      cd repo
      
      echo "[2/7] Filtering to public paths..."
      git filter-repo --force \
        --path README.md \
        --path LICENSE \
        --path atlantis.yaml \
        --path renovate.json \
        --path k8s/ \
        --path network/configs/ \
        --path network/scripts/ \
        --path ansible/playbooks/ \
        --path ci/cisco.yml \
        --path ci/docker.yml \
        --path ci/k8s.yml \
        --path ci/github-sync.yml \
        --path docker/nl-matrix01/matrix/
      
      echo "[3/7] Applying static sanitization patterns..."
      cat > /tmp/replacements.txt << 'EOF'
      # Docker hosts
      nl-matrix01==>nl-matrix01
      
      # Site prefixes
      nl==>nl
      gr==>gr
      
      # Domains
      gitlab.example.net==>gitlab.example.net
      registry.example.net==>registry.example.net
      api-k8s.example.net==>api-k8s.example.net
      gr-api-k8s.example.net==>gr-api-k8s.example.net
      example.net==>example.net
      
      # Node names (Proxmox)
      nl-pve01==>nl-pve01
      nl-pve02==>nl-pve02
      nl-pve03==>nl-pve03
      gr-pve01==>gr-pve01
      gr-pve02==>gr-pve02
      
      # Node names (OpenBao)
      nl-vault01==>nl-vault01
      nl-vault02==>nl-vault02
      gr-vault01==>gr-vault01
      
      # Node names (FRR)
      nl-rtr01==>nl-rtr01
      nl-rtr02==>nl-rtr02
      gr-rtr01==>gr-rtr01
      gr-rtr02==>gr-rtr02
      
      # Node names (Synology)
      nl-nas01==>nl-nas01
      
      # Node names (other)
      nl-lte01==>nl-lte01
      
      # Controller naming
      ctrl01==>ctrl01
      ctrl02==>ctrl02
      ctrl03==>ctrl03
      
      # IP addresses
      regex:192\.168\.\d{1,3}\.\d{1,3}==>10.0.X.X
      regex:172\.16\.\d{1,3}\.\d{1,3}==>10.1.X.X
      
      # Location details
      Netherlands==>Netherlands
      Greece==>Greece
      EOF
      git filter-repo --force --replace-text /tmp/replacements.txt
      
      echo "[4/7] Scanning for secrets with gitleaks..."
      # Run gitleaks and capture findings (don't fail on findings)
      gitleaks detect --source . --no-git --report-format json --report-path /tmp/leaks.json 2>/dev/null || true
      
      echo "[5/7] Auto-sanitizing detected secrets..."
      if [ -f /tmp/leaks.json ] && [ -s /tmp/leaks.json ] && [ "$(cat /tmp/leaks.json)" != "[]" ]; then
        echo "Found secrets, generating dynamic replacements..."
        
        # Extract unique secrets and create replacements
        COUNTER=1
        for secret in $(cat /tmp/leaks.json | jq -r '.[].Secret // empty' | sort -u); do
          if [ -n "$secret" ] && [ ${#secret} -gt 6 ]; then
            HASH=$(echo -n "$secret" | md5sum | cut -c1-8)
            echo "${secret}==>REDACTED_${HASH}" >> /tmp/dynamic_replacements.txt
            echo "  - Redacting secret (${#secret} chars) -> REDACTED_${HASH}"
            COUNTER=$((COUNTER + 1))
          fi
        done
        
        if [ -f /tmp/dynamic_replacements.txt ] && [ -s /tmp/dynamic_replacements.txt ]; then
          echo "Applying $(wc -l < /tmp/dynamic_replacements.txt) dynamic replacements..."
          git filter-repo --force --replace-text /tmp/dynamic_replacements.txt
        fi
      else
        echo "No secrets detected by gitleaks"
      fi
      
      echo "[6/7] Reorganizing structure..."
      git filter-repo --force --path-rename k8s/:kubernetes/
      
      echo "[7/7] Final verification and push..."
      # Final scan to confirm clean
      FINAL_LEAKS=$(gitleaks detect --source . --no-git 2>&1 || true)
      if echo "$FINAL_LEAKS" | grep -q "leaks found"; then
        echo "⚠️  Warning: Some secrets may still exist after sanitization"
        echo "$FINAL_LEAKS"
        echo "Continuing with push - review GitHub repo after sync"
      else
        echo "✅ Final scan clean - no secrets detected"
      fi
      
      git remote add github "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git"
      git push github main --force
      
      echo "================================================"
      echo "SUCCESS: https://github.com/${GITHUB_REPO}"
      echo "================================================"
  environment:
    name: github-public
    url: https://github.com/$GITHUB_REPO

# ===========================================================================
# DRY RUN - Test without pushing
# ===========================================================================

github_sync_dry_run:
  extends: .github_sync_base
  needs: []
  stage: validate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
  script:
    - |
      set -e
      echo "================================================"
      echo "GitHub Sync - DRY RUN (no push)"
      echo "================================================"
      
      git clone "${CI_REPOSITORY_URL}" repo
      cd repo
      
      echo "[1/4] Filtering paths..."
      git filter-repo --force \
        --path README.md \
        --path LICENSE \
        --path atlantis.yaml \
        --path renovate.json \
        --path k8s/ \
        --path network/configs/ \
        --path network/scripts/ \
        --path ansible/playbooks/ \
        --path ci/cisco.yml \
        --path ci/docker.yml \
        --path ci/k8s.yml \
        --path ci/github-sync.yml \
        --path docker/nl-matrix01/matrix/
      
      echo "[2/4] Scanning BEFORE sanitization..."
      echo "--- Pre-sanitization secrets ---"
      gitleaks detect --source . --no-git -v 2>&1 | head -50 || true
      
      echo "[3/4] Applying sanitization..."
      cat > /tmp/replacements.txt << 'EOF'
      nl-matrix01==>nl-matrix01
      nl==>nl
      gr==>gr
      gitlab.example.net==>gitlab.example.net
      registry.example.net==>registry.example.net
      api-k8s.example.net==>api-k8s.example.net
      gr-api-k8s.example.net==>gr-api-k8s.example.net
      example.net==>example.net
      nl-pve01==>nl-pve01
      nl-pve02==>nl-pve02
      nl-pve03==>nl-pve03
      gr-pve01==>gr-pve01
      gr-pve02==>gr-pve02
      nl-vault01==>nl-vault01
      nl-vault02==>nl-vault02
      gr-vault01==>gr-vault01
      nl-rtr01==>nl-rtr01
      nl-rtr02==>nl-rtr02
      gr-rtr01==>gr-rtr01
      gr-rtr02==>gr-rtr02
      nl-nas01==>nl-nas01
      nl-lte01==>nl-lte01
      ctrl01==>ctrl01
      ctrl02==>ctrl02
      ctrl03==>ctrl03
      regex:192\.168\.\d{1,3}\.\d{1,3}==>10.0.X.X
      regex:172\.16\.\d{1,3}\.\d{1,3}==>10.1.X.X
      Netherlands==>Netherlands
      Greece==>Greece
      EOF
      git filter-repo --force --replace-text /tmp/replacements.txt
      
      # Auto-sanitize detected secrets
      gitleaks detect --source . --no-git --report-format json --report-path /tmp/leaks.json 2>/dev/null || true
      if [ -f /tmp/leaks.json ] && [ -s /tmp/leaks.json ] && [ "$(cat /tmp/leaks.json)" != "[]" ]; then
        for secret in $(cat /tmp/leaks.json | jq -r '.[].Secret // empty' | sort -u); do
          if [ -n "$secret" ] && [ ${#secret} -gt 6 ]; then
            HASH=$(echo -n "$secret" | md5sum | cut -c1-8)
            echo "${secret}==>REDACTED_${HASH}" >> /tmp/dynamic_replacements.txt
          fi
        done
        if [ -f /tmp/dynamic_replacements.txt ]; then
          git filter-repo --force --replace-text /tmp/dynamic_replacements.txt
        fi
      fi
      
      git filter-repo --force --path-rename k8s/:kubernetes/
      
      echo "[4/4] Scanning AFTER sanitization..."
      echo "--- Post-sanitization secrets ---"
      gitleaks detect --source . --no-git -v 2>&1 | head -50 || true
      
      echo "================================================"
      echo "DRY RUN COMPLETE - No push performed"
      echo "Review output above for any remaining issues"
      echo "================================================"

# ===========================================================================
# BUILD THE RUNNER IMAGE
# ===========================================================================

build_github_sync_runner:
  stage: .pre
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - docker/nlgitlab01/github-sync-runner/**/*
      when: manual
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      cd docker/nlgitlab01/github-sync-runner
      docker build -t $GITHUB_SYNC_IMAGE .
      docker push $GITHUB_SYNC_IMAGE
  environment:
    name: docker-registry
