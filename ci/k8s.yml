# K8s jobs use stages defined in main _gitlab-ci.yml
# Stages: drift-detection, validate, pre-deploy, deploy, verify

variables:
  K8S_DIR: "k8s"
  TF_STATE_NAME: "k8s-production-state"
  PLAN_CACHE: "artifacts/plan-production.cache"

validate_k8s_manifests:
  stage: validate
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - cd "$K8S_DIR"
    - tofu fmt -check -recursive . 2>/dev/null || echo "Formatting issues (non-critical)"
    - export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
    - tofu init -input=false
    - tofu validate
    - echo "Validation passed"
  allow_failure: false

plan_k8s_infrastructure:
  stage: pre-deploy
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  needs:
    - validate_k8s_manifests
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
    - mkdir -p artifacts
  script:
    - echo "Planning Kubernetes Infrastructure"
    - cd "$K8S_DIR"
    - export TF_VAR_k8s_host="$K8S_HOST"
    - export TF_VAR_k8s_token="$K8S_TOKEN"
    - export TF_VAR_k8s_ca_cert="$K8S_CA_CERT"
    - export TF_VAR_pihole_password="${PIHOLE_PASSWORD:-changeme123}"
    - export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
    - tofu init -input=false
    - tofu plan -detailed-exitcode -out="../$PLAN_CACHE" -input=false || true
    - echo "Plan saved to $PLAN_CACHE"
    - echo "Plan stage complete"
  artifacts:
    when: always
    paths:
      - artifacts/plan-*.cache
    expire_in: 1 day
  allow_failure: false

apply_k8s_infrastructure:
  stage: deploy
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: manual
  needs:
    - plan_k8s_infrastructure
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - cd "$K8S_DIR"
    - export TF_VAR_k8s_host="$K8S_HOST"
    - export TF_VAR_k8s_token="$K8S_TOKEN"
    - export TF_VAR_k8s_ca_cert="$K8S_CA_CERT"
    - export TF_VAR_pihole_password="${PIHOLE_PASSWORD:-changeme123}"
    - |
      tofu init -input=false \
        -backend-config="address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}" \
        -backend-config="lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock" \
        -backend-config="unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock" \
        -backend-config="username=gitlab-ci-token" \
        -backend-config="password=${CI_JOB_TOKEN}" \
        -backend-config="lock_method=POST" \
        -backend-config="unlock_method=DELETE" \
        -backend-config="retry_wait_min=5"
    - tofu apply -input=false "../$PLAN_CACHE"
    - echo "Infrastructure applied"
    - tofu output || true
  environment:
    name: production
  allow_failure: false

verify_k8s_infrastructure:
  stage: verify
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  needs:
    - apply_k8s_infrastructure
  script:
    - mkdir -p ~/.kube
    - |
      cat > ~/.kube/config <<EOF
      apiVersion: v1
      kind: Config
      clusters:
      - cluster:
          certificate-authority-data: ${K8S_CA_CERT}
          server: ${K8S_HOST}
        name: k8s-cluster
      contexts:
      - context:
          cluster: k8s-cluster
          user: gitlab-ci
        name: gitlab-ci
      current-context: gitlab-ci
      users:
      - name: gitlab-ci
        user:
          token: ${K8S_TOKEN}
      EOF
    - kubectl get namespaces || true
    - kubectl get all -n pihole || true
    - kubectl wait --for=condition=ready pod -l app=pihole -n pihole --timeout=300s || true
    - kubectl get svc -n pihole || true
    - echo "Verification complete"
  allow_failure: true