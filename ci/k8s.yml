# K8s jobs use stages defined in main _gitlab-ci.yml
# Stages: drift-detection, validate, pre-deploy, deploy, verify

variables:
  K8S_DIR: "k8s"
  TF_STATE_NAME: "k8s-production-state"
  PLAN_CACHE: "artifacts/plan-production.cache"

validate_k8s_manifests:
  stage: validate
  image: $K8S_RUNNER_IMAGE
  tags:
    - docker
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Validating Kubernetes OpenTofu Configuration"
      echo "PRODUCTION ONLY"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep "^k8s/" || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No k8s configuration changes detected"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      
      echo ""
      echo "Validating: Production infrastructure"
      echo "------------------------------------------------"
      
      cd "$K8S_DIR"
      
      if [ ! -f "main.tf" ]; then
        echo "  ERROR: main.tf not found"
        exit 1
      fi
      
      echo "  Found OpenTofu configuration"
      
      # Format check
      echo "  Running tofu fmt check..."
      tofu fmt -check -recursive . 2>/dev/null || echo "  WARNING: Formatting issues detected (non-critical)"
      
      # Initialize for validation
      echo "  Running tofu validate..."
      
      # Set backend config for validation
      export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
      
      tofu init -input=false
      tofu validate
      
      echo "  SUCCESS: Validation passed"
      exit 0
  allow_failure: false

plan_k8s_infrastructure:
  stage: pre-deploy
  image: $K8S_RUNNER_IMAGE
  tags:
    - docker
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  needs:
    - validate_k8s_manifests
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
    - mkdir -p artifacts
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Planning Kubernetes Infrastructure Changes"
      echo "PRODUCTION"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep "^k8s/" || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No k8s configuration changes detected"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      
      # Validate credentials
      if [ -z "$K8S_HOST" ] || [ -z "$K8S_TOKEN" ] || [ -z "$K8S_CA_CERT" ]; then
        echo "ERROR: Missing K8s credentials"
        echo "Required variables: K8S_HOST, K8S_TOKEN, K8S_CA_CERT"
        exit 1
      fi
      
      echo "Credentials validated"
      echo "  API Server: [MASKED]"
      echo "  Token length: ${#K8S_TOKEN} chars"
      echo "  CA cert length: ${#K8S_CA_CERT} chars"
      echo "================================================"
      
      cd "$K8S_DIR"
      
      echo ""
      echo "Planning: Production infrastructure"
      echo "================================================"
      echo "  State backend: $TF_STATE_NAME"
      
      # Export variables for OpenTofu
      export TF_VAR_k8s_host="$K8S_HOST"
      export TF_VAR_k8s_token="$K8S_TOKEN"
      export TF_VAR_k8s_ca_cert="$K8S_CA_CERT"
      export TF_VAR_pihole_password="${PIHOLE_PASSWORD:-changeme123}"
      
      # Backend configuration
      export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
      
      # Initialize
      echo "  Initializing OpenTofu..."
      tofu init -input=false
      echo "  Initialization successful"
      
      # Create plan
      echo "  Creating plan..."
      tofu plan -out="../$PLAN_CACHE" -input=false
      
      echo "  SUCCESS: Plan created"
      echo "  Plan saved to: $PLAN_CACHE"
      echo ""
      echo "================================================"
      echo "Plan stage completed successfully"
      echo "================================================"
      
      # ALWAYS exit 0 if we got here
      exit 0
  artifacts:
    when: always
    paths:
      - artifacts/plan-*.cache
    expire_in: 1 day
  allow_failure: false

apply_k8s_infrastructure:
  stage: deploy
  image: $K8S_RUNNER_IMAGE
  tags:
    - docker
  rules:
    - changes:
        - k8s/**/*
      when: manual
  needs:
    - plan_k8s_infrastructure
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Applying Kubernetes Infrastructure"
      echo "PRODUCTION"
      echo "================================================"
      
      if [ ! -f "$PLAN_CACHE" ]; then
        echo "ERROR: Plan cache not found: $PLAN_CACHE"
        echo "Run plan stage first"
        exit 1
      fi
      
      echo "Plan cache found: $PLAN_CACHE"
      echo ""
      
      cd "$K8S_DIR"
      
      # Export variables
      export TF_VAR_k8s_host="$K8S_HOST"
      export TF_VAR_k8s_token="$K8S_TOKEN"
      export TF_VAR_k8s_ca_cert="$K8S_CA_CERT"
      export TF_VAR_pihole_password="${PIHOLE_PASSWORD:-changeme123}"
      
      # Backend configuration
      export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
      
      # Initialize
      echo "Initializing OpenTofu..."
      tofu init -input=false
      echo "Initialization successful"
      echo ""
      
      # Apply
      echo "Applying infrastructure..."
      echo "================================================"
      tofu apply -input=false "../$PLAN_CACHE"
      
      echo ""
      echo "================================================"
      echo "SUCCESS: Infrastructure applied"
      echo "================================================"
      echo ""
      echo "Outputs:"
      tofu output || echo "No outputs defined"
      
      exit 0
  environment:
    name: production
  allow_failure: false

verify_k8s_infrastructure:
  stage: verify
  image: $K8S_RUNNER_IMAGE
  tags:
    - docker
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  needs:
    - apply_k8s_infrastructure
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Verifying Kubernetes Infrastructure"
      echo "================================================"
      
      # Setup kubeconfig
      mkdir -p ~/.kube
      
      cat > ~/.kube/config <<EOF
      apiVersion: v1
      kind: Config
      clusters:
      - cluster:
          certificate-authority-data: ${K8S_CA_CERT}
          server: ${K8S_HOST}
        name: k8s-cluster
      contexts:
      - context:
          cluster: k8s-cluster
          user: gitlab-ci
        name: gitlab-ci
      current-context: gitlab-ci
      users:
      - name: gitlab-ci
        user:
          token: ${K8S_TOKEN}
      EOF
      
      echo "Checking namespaces..."
      kubectl get namespaces || true
      echo ""
      
      echo "Checking Pi-hole deployment..."
      kubectl get all -n pihole || true
      echo ""
      
      echo "Checking Pi-hole pod status..."
      kubectl wait --for=condition=ready pod -l app=pihole -n pihole --timeout=300s || echo "  WARNING: Pi-hole pod not ready yet"
      echo ""
      
      echo "Checking services..."
      kubectl get svc -n pihole || true
      echo ""
      
      echo "================================================"
      echo "Verification complete"
      echo "================================================"
      echo ""
      echo "Access Pi-hole:"
      echo "  kubectl port-forward -n pihole svc/pihole-web 8080:80"
      echo "  Then visit: http://localhost:8080/admin"
      echo ""
      
      exit 0
  allow_failure: true