# K8s Pipeline - Hybrid Approach
# - OpenTofu uses K8S_HOST, K8S_TOKEN, K8S_CA_CERT variables
# - kubectl uses GitLab Agent (verify stage)

variables:
  K8S_DIR: "k8s"
  TF_STATE_NAME: "k8s-production-state"
  KUBE_CONTEXT: "infrastructure/nl/production:k8s-agent"

validate_k8s_manifests:
  stage: validate
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - cd "$K8S_DIR"
    - tofu fmt -check -recursive . 2>/dev/null || echo "Formatting issues (non-critical)"
    - export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
    - tofu init -input=false
    - tofu validate
    - echo "Validation passed"
  allow_failure: false

plan_k8s_infrastructure:
  stage: pre-deploy
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  needs:
    - validate_k8s_manifests
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
    - mkdir -p artifacts
  script:
    - echo "Planning Kubernetes Infrastructure"
    - cd "$K8S_DIR"
    - export TF_VAR_k8s_host="$K8S_HOST"
    - export TF_VAR_k8s_token="$K8S_TOKEN"
    - export TF_VAR_k8s_ca_cert="$K8S_CA_CERT"
    - export TF_VAR_pihole_password="${PIHOLE_PASSWORD:-changeme123}"
    - export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
    - tofu init -input=false
    - tofu plan -detailed-exitcode -out="../$PLAN_CACHE" -input=false || true
    - echo "Plan stage complete"
  artifacts:
    when: always
    paths:
      - artifacts/plan-*.cache
    expire_in: 1 day
  allow_failure: false

apply_k8s_infrastructure:
  stage: deploy
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: manual
  needs:
    - plan_k8s_infrastructure
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - cd "$K8S_DIR"
    - export TF_VAR_k8s_host="$K8S_HOST"
    - export TF_VAR_k8s_token="$K8S_TOKEN"
    - export TF_VAR_k8s_ca_cert="$K8S_CA_CERT"
    - export TF_VAR_pihole_password="${PIHOLE_PASSWORD:-changeme123}"
    - export TF_HTTP_ADDRESS="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}"
    - export TF_HTTP_LOCK_ADDRESS="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock"
    - export TF_HTTP_UNLOCK_ADDRESS="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock"
    - export TF_HTTP_USERNAME="gitlab-ci-token"
    - export TF_HTTP_PASSWORD="${CI_JOB_TOKEN}"
    - export TF_HTTP_LOCK_METHOD="POST"
    - export TF_HTTP_UNLOCK_METHOD="DELETE"
    - export TF_HTTP_RETRY_WAIT_MIN="5"
    - tofu init -input=false -reconfigure
    - echo "Running fresh plan in apply stage"
    - tofu plan -out=apply.tfplan -input=false
    - echo "Applying infrastructure changes"
    - tofu apply -input=false apply.tfplan
    - echo "Infrastructure applied successfully"
    - tofu output || true
  environment:
    name: production
  allow_failure: false

verify_k8s_infrastructure:
  stage: verify
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  needs:
    - apply_k8s_infrastructure
  before_script:
    # Use GitLab Agent for kubectl!
    - kubectl config use-context "$KUBE_CONTEXT"
  script:
    - echo "Verifying Kubernetes deployment via GitLab Agent"
    - kubectl get namespaces
    - kubectl get all -n pihole
    - kubectl wait --for=condition=ready pod -l app=pihole -n pihole --timeout=300s || true
    - kubectl get svc -n pihole
    - echo "Verification complete"
  environment:
    name: production
    kubernetes:
      agent: k8s-agent
  allow_failure: true