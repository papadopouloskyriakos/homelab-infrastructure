# Kubernetes Infrastructure Pipeline (OpenTofu)
# Manages PRODUCTION Kubernetes resources via OpenTofu with GitLab-managed state
# Directory structure: k8s/ (production only, no sandbox)

.k8s_base:
  image: $K8S_IMAGE
  tags:
    - k8s

# Validate OpenTofu configurations
validate_k8s_manifests:
  extends: .k8s_base
  stage: validate
  rules:
    - changes:
        - k8s/**/*
      when: on_success
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Validating Kubernetes OpenTofu Configuration"
      echo "PRODUCTION ONLY"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^k8s/' || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No Kubernetes configuration changes detected"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      echo ""
      
      K8S_DIR="k8s"
      
      echo "Validating: Production infrastructure"
      echo "------------------------------------------------"
      
      if [ ! -d "$K8S_DIR" ]; then
        echo "  ERROR: k8s/ directory not found"
        exit 1
      fi
      
      cd "$K8S_DIR"
      
      if [ ! -f "main.tf" ] && [ ! -f "main.tf.json" ]; then
        echo "  ERROR: No main.tf or main.tf.json found"
        exit 1
      fi
      
      echo "  Found OpenTofu configuration"
      
      echo "  Running tofu fmt check..."
      if ! tofu fmt -check -recursive .; then
        echo "  WARNING: Formatting issues detected (non-critical)"
      fi
      
      echo "  Running tofu validate..."
      
      if ! tofu init -backend=false 2>&1 | grep -v "backend initialization"; then
        echo "  ERROR: Failed to initialize for validation"
        exit 1
      fi
      
      if ! tofu validate; then
        echo "  ERROR: Validation failed"
        exit 1
      fi
      
      echo "  PASS: Validation successful"
      
      cd "$CI_PROJECT_DIR"
      
      echo ""
      echo "================================================"
      echo "SUCCESS: All validations passed"
      echo "================================================"
  artifacts:
    when: always
    expire_in: 7 days
  allow_failure: false

# Plan Kubernetes infrastructure changes
plan_k8s_infrastructure:
  extends: .k8s_base
  stage: pre-deploy
  rules:
    - changes:
        - k8s/**/*
      when: on_success
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  needs:
    - validate_k8s_manifests
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Planning Kubernetes Infrastructure Changes"
      echo "PRODUCTION"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^k8s/' || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No changes detected"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      echo ""
      
      if [ -z "${K8S_HOST:-}" ]; then
        echo "ERROR: K8S_HOST not set in GitLab CI/CD variables"
        exit 1
      fi
      
      if [ -z "${K8S_TOKEN:-}" ]; then
        echo "ERROR: K8S_TOKEN not set in GitLab CI/CD variables"
        exit 1
      fi
      
      if [ -z "${K8S_CA_CERT:-}" ]; then
        echo "ERROR: K8S_CA_CERT not set in GitLab CI/CD variables"
        exit 1
      fi
      
      echo "Credentials validated"
      echo "  API Server: $K8S_HOST"
      echo "  Token length: ${#K8S_TOKEN} chars"
      echo "  CA cert length: ${#K8S_CA_CERT} chars"
      echo ""
      
      K8S_DIR="k8s"
      STATE_NAME="${K8S_TF_STATE_NAME:-k8s-production}"
      PLAN_FILE="$CI_PROJECT_DIR/artifacts/plan-production.cache"
      
      mkdir -p "$CI_PROJECT_DIR/artifacts"
      
      echo "================================================"
      echo "Planning: Production infrastructure"
      echo "================================================"
      
      cd "$K8S_DIR"
      
      export TF_HTTP_ADDRESS="$CI_API_V4_URL/projects/$CI_PROJECT_ID/terraform/state/$STATE_NAME"
      export TF_HTTP_LOCK_ADDRESS="$TF_HTTP_ADDRESS/lock"
      export TF_HTTP_UNLOCK_ADDRESS="$TF_HTTP_ADDRESS/lock"
      export TF_HTTP_USERNAME="gitlab-ci-token"
      export TF_HTTP_PASSWORD="$CI_JOB_TOKEN"
      export TF_HTTP_LOCK_METHOD="POST"
      export TF_HTTP_UNLOCK_METHOD="DELETE"
      
      echo "  State backend: $STATE_NAME"
      echo "  Initializing OpenTofu..."
      
      INIT_SUCCESS=0
      for attempt in 1 2 3; do
        if tofu init -reconfigure; then
          INIT_SUCCESS=1
          break
        else
          echo "  Initialization attempt $attempt failed"
          if [ $attempt -lt 3 ]; then
            echo "  Retrying in 10 seconds..."
            sleep 10
          fi
        fi
      done
      
      if [ $INIT_SUCCESS -eq 0 ]; then
        echo "  ERROR: Failed to initialize after 3 attempts"
        exit 1
      fi
      
      echo "  Initialization successful"
      echo ""
      echo "  Creating plan..."
      
      if tofu plan -out="$PLAN_FILE" \
        -var "k8s_host=${K8S_HOST}" \
        -var "k8s_token=${K8S_TOKEN}" \
        -var "k8s_ca_cert=${K8S_CA_CERT}"; then
        
        echo "  SUCCESS: Plan created"
        echo "  Plan saved to: artifacts/plan-production.cache"
        
        echo ""
        echo "  Plan summary:"
        tofu show "$PLAN_FILE" | head -50 | sed 's/^/    /'
        
      else
        echo "  ERROR: Plan creation failed"
        exit 1
      fi
      
      cd "$CI_PROJECT_DIR"
      
      echo ""
      echo "================================================"
      echo "SUCCESS: Plan created"
      echo "================================================"
      echo ""
      echo "Review plan in artifacts before applying"
  artifacts:
    when: always
    paths:
      - artifacts/plan-*.cache
    expire_in: 7 days
  allow_failure: false

# Apply Kubernetes infrastructure changes
apply_k8s_infrastructure:
  extends: .k8s_base
  stage: deploy
  rules:
    - changes:
        - k8s/**/*
      when: manual
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  needs:
    - plan_k8s_infrastructure
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Applying Kubernetes Infrastructure Changes"
      echo "PRODUCTION"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^k8s/' || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No changes detected"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      echo ""
      
      if [ -z "${K8S_HOST:-}" ]; then
        echo "ERROR: K8S_HOST not set"
        exit 1
      fi
      
      if [ -z "${K8S_TOKEN:-}" ]; then
        echo "ERROR: K8S_TOKEN not set"
        exit 1
      fi
      
      if [ -z "${K8S_CA_CERT:-}" ]; then
        echo "ERROR: K8S_CA_CERT not set"
        exit 1
      fi
      
      K8S_DIR="k8s"
      STATE_NAME="${K8S_TF_STATE_NAME:-k8s-production}"
      PLAN_FILE="$CI_PROJECT_DIR/artifacts/plan-production.cache"
      
      echo "================================================"
      echo "Applying: Production infrastructure"
      echo "================================================"
      
      if [ ! -f "$PLAN_FILE" ]; then
        echo "ERROR: Plan file not found: $PLAN_FILE"
        echo "Plan must be created first"
        exit 1
      fi
      
      cd "$K8S_DIR"
      
      export TF_HTTP_ADDRESS="$CI_API_V4_URL/projects/$CI_PROJECT_ID/terraform/state/$STATE_NAME"
      export TF_HTTP_LOCK_ADDRESS="$TF_HTTP_ADDRESS/lock"
      export TF_HTTP_UNLOCK_ADDRESS="$TF_HTTP_ADDRESS/lock"
      export TF_HTTP_USERNAME="gitlab-ci-token"
      export TF_HTTP_PASSWORD="$CI_JOB_TOKEN"
      export TF_HTTP_LOCK_METHOD="POST"
      export TF_HTTP_UNLOCK_METHOD="DELETE"
      
      echo "  Initializing OpenTofu..."
      
      INIT_SUCCESS=0
      for attempt in 1 2 3; do
        if tofu init -reconfigure; then
          INIT_SUCCESS=1
          break
        else
          echo "  Initialization attempt $attempt failed"
          if [ $attempt -lt 3 ]; then
            echo "  Retrying in 10 seconds..."
            sleep 10
          fi
        fi
      done
      
      if [ $INIT_SUCCESS -eq 0 ]; then
        echo "  ERROR: Failed to initialize"
        exit 1
      fi
      
      echo "  Applying plan..."
      
      if tofu apply "$PLAN_FILE" 2>&1 | tee "$CI_PROJECT_DIR/artifacts/apply-production.log"; then
        echo ""
        echo "  SUCCESS: Infrastructure applied"
      else
        echo ""
        echo "  ERROR: Apply failed"
        echo "  Check log: artifacts/apply-production.log"
        exit 1
      fi
      
      cd "$CI_PROJECT_DIR"
      
      echo ""
      echo "================================================"
      echo "SUCCESS: Infrastructure applied"
      echo "================================================"
  artifacts:
    when: always
    paths:
      - artifacts/
    expire_in: 7 days
  environment: production
  allow_failure: false

# Verify Kubernetes deployments
verify_k8s_infrastructure:
  extends: .k8s_base
  stage: verify
  rules:
    - changes:
        - k8s/**/*
      when: on_success
    - if: '$CI_COMMIT_AUTHOR_NAME == "GitLab CI Auto-Sync"'
      when: never
  needs:
    - apply_k8s_infrastructure
  script:
    - |
      set -eu
      
      echo "================================================"
      echo "Verifying Kubernetes Infrastructure"
      echo "PRODUCTION"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^k8s/' || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No changes to verify"
        exit 0
      fi
      
      if [ -z "${K8S_HOST:-}" ]; then
        echo "ERROR: K8S_HOST not set"
        exit 1
      fi
      
      if [ -z "${K8S_TOKEN:-}" ]; then
        echo "ERROR: K8S_TOKEN not set"
        exit 1
      fi
      
      if [ -z "${K8S_CA_CERT:-}" ]; then
        echo "ERROR: K8S_CA_CERT not set"
        exit 1
      fi
      
      echo "Configuring kubectl..."
      
      echo "$K8S_CA_CERT" | base64 -d > /tmp/ca.crt
      
      kubectl config set-cluster k8s-cluster \
        --server="$K8S_HOST" \
        --certificate-authority=/tmp/ca.crt \
        --embed-certs=true
      
      kubectl config set-credentials gitlab-ci \
        --token="$K8S_TOKEN"
      
      kubectl config set-context k8s-context \
        --cluster=k8s-cluster \
        --user=gitlab-ci
      
      kubectl config use-context k8s-context
      
      echo "  kubectl configured"
      echo ""
      
      echo "Testing cluster connectivity..."
      if ! kubectl cluster-info 2>&1 | head -5; then
        echo "WARNING: Could not get cluster info"
      fi
      echo ""
      
      echo "Listing namespaces..."
      kubectl get namespaces 2>&1 | sed 's/^/  /' || echo "  WARNING: Could not list namespaces"
      echo ""
      
      echo "Checking production namespace..."
      
      if kubectl get namespace production &>/dev/null; then
        echo "  Namespace exists"
        
        echo ""
        echo "  Resources in production:"
        kubectl get all -n production 2>&1 | sed 's/^/    /' || echo "    No resources found"
      else
        echo "  WARNING: Production namespace not found"
      fi
      
      echo ""
      echo "================================================"
      echo "SUCCESS: Verification complete"
      echo "================================================"
  artifacts:
    when: always
    expire_in: 7 days
  allow_failure: true