***REMOVED***
# K8s Pipeline - Validation Only (Atlantis handles plan/apply)
***REMOVED***
# - GitLab CI: Format checking, validation, security scanning
# - Atlantis: Plan and Apply via MR comments
# - State stored in GitLab Terraform backend
***REMOVED***

variables:
  K8S_DIR: "k8s"
  KUBE_CONTEXT: "infrastructure/nl/production:k8s-agent"

# -----------------------------------------------------------------------------
# Validate Stage - Runs on every push to k8s/**
# -----------------------------------------------------------------------------
validate_k8s_manifests:
  stage: validate
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - cd "$K8S_DIR"
    
    # Format check
    - echo "=== Checking formatting ==="
    - tofu fmt -check -recursive . || { echo "⚠️ Run 'tofu fmt' to fix formatting"; exit 1; }
    
    # Initialize without backend (just for validation)
    - echo "=== Initializing (validation mode) ==="
    - tofu init -backend=false -input=false
    
    # Validate syntax
    - echo "=== Validating configuration ==="
    - tofu validate
    
    - echo "✅ Validation passed - Atlantis will handle plan/apply in MR"
  allow_failure: false

# -----------------------------------------------------------------------------
# Verify Stage - Runs after merge to main (post-Atlantis apply)
# -----------------------------------------------------------------------------
verify_k8s_infrastructure:
  stage: verify
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - k8s/**/*
      when: on_success
  before_script:
    - kubectl config use-context "$KUBE_CONTEXT"
  script:
    - echo "=== Verifying K8s infrastructure (post-Atlantis apply) ==="
    
    # Cluster health
    - kubectl get nodes
    
    # Workload status
    - echo "=== Workloads ==="
    - kubectl get pods -A | grep -E "(pihole|monitoring|ingress|nfs|gitlab|awx)" || true
    
    # Key services
    - echo "=== Services ==="
    - kubectl get svc -A | grep NodePort || true
    
    - echo "✅ Verification complete"
  environment:
    name: production
    kubernetes:
      agent: k8s-agent
  allow_failure: true