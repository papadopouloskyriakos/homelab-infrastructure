# K8s jobs use stages defined in main _gitlab-ci.yml
# Stages: drift-detection, validate, pre-deploy, deploy, verify

variables:
  K8S_DIR: "k8s"
  TF_STATE_NAME: "k8s-production-state"
  PLAN_CACHE: "artifacts/plan-production.cache"

validate_k8s_manifests:
  stage: validate
  image: $K8S_RUNNER_IMAGE
  tags:
    - docker
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - |
      echo "================================================"
      echo "Validating Kubernetes OpenTofu Configuration"
      echo "PRODUCTION ONLY"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep "^k8s/" || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No k8s configuration changes detected"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      
      cd "$K8S_DIR"
      
      if [ ! -f "main.tf" ]; then
        echo "  ERROR: main.tf not found"
        exit 1
      fi
      
      echo "  Found OpenTofu configuration"
      echo "  Running tofu fmt check..."
      tofu fmt -check -recursive . 2>/dev/null || echo "  WARNING: Formatting issues"
      
      echo "  Running tofu validate..."
      export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
      
      tofu init -input=false
      tofu validate
      echo "  SUCCESS: Validation passed"
  allow_failure: false

plan_k8s_infrastructure:
  stage: pre-deploy
  image: $K8S_RUNNER_IMAGE
  tags:
    - docker
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  needs:
    - validate_k8s_manifests
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
    - mkdir -p artifacts
  script:
    - |
      echo "================================================"
      echo "Planning Kubernetes Infrastructure Changes"
      echo "PRODUCTION"
      echo "================================================"
      
      CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | grep "^k8s/" || true)
      
      if [ -z "$CHANGED" ]; then
        echo "No k8s configuration changes detected"
        exit 0
      fi
      
      echo "Changed files:"
      echo "$CHANGED" | sed 's/^/  /'
      echo "================================================"
      
      if [ -z "$K8S_HOST" ] || [ -z "$K8S_TOKEN" ] || [ -z "$K8S_CA_CERT" ]; then
        echo "ERROR: Missing K8s credentials"
        exit 1
      fi
      
      echo "Credentials validated"
      echo "  API Server: [MASKED]"
      echo "  Token length: ${#K8S_TOKEN} chars"
      echo "  CA cert length: ${#K8S_CA_CERT} chars"
      echo "================================================"
      
      cd "$K8S_DIR"
      
      echo "Planning: Production infrastructure"
      echo "  State backend: $TF_STATE_NAME"
      
      export TF_VAR_k8s_host="$K8S_HOST"
      export TF_VAR_k8s_token="$K8S_TOKEN"
      export TF_VAR_k8s_ca_cert="$K8S_CA_CERT"
      export TF_VAR_pihole_password="${PIHOLE_PASSWORD:-changeme123}"
      
      export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
      
      echo "  Initializing OpenTofu..."
      tofu init -input=false || exit 1
      echo "  Initialization successful"
      
      echo "  Creating plan..."
      tofu plan -out="../$PLAN_CACHE" -input=false
      PLAN_STATUS=$?
      
      if [ $PLAN_STATUS -eq 0 ] || [ $PLAN_STATUS -eq 2 ]; then
        echo "  Plan created successfully"
        echo "  Plan saved to: $PLAN_CACHE"
        echo "================================================"
        echo "SUCCESS"
        echo "================================================"
        true
      else
        echo "  ERROR: Plan failed with status $PLAN_STATUS"
        false
      fi
  artifacts:
    when: always
    paths:
      - artifacts/plan-*.cache
    expire_in: 1 day
  allow_failure: false

apply_k8s_infrastructure:
  stage: deploy
  image: $K8S_RUNNER_IMAGE
  tags:
    - docker
  rules:
    - changes:
        - k8s/**/*
      when: manual
  needs:
    - plan_k8s_infrastructure
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - |
      if [ ! -f "$PLAN_CACHE" ]; then
        echo "ERROR: Plan cache not found"
        exit 1
      fi
      
      cd "$K8S_DIR"
      
      export TF_VAR_k8s_host="$K8S_HOST"
      export TF_VAR_k8s_token="$K8S_TOKEN"
      export TF_VAR_k8s_ca_cert="$K8S_CA_CERT"
      export TF_VAR_pihole_password="${PIHOLE_PASSWORD:-changeme123}"
      
      export TF_CLI_ARGS_init="-backend-config=address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME} -backend-config=lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}/lock -backend-config=username=gitlab-ci-token -backend-config=password=${CI_JOB_TOKEN} -backend-config=lock_method=POST -backend-config=unlock_method=DELETE -backend-config=retry_wait_min=5"
      
      tofu init -input=false
      tofu apply -input=false "../$PLAN_CACHE"
      
      echo "SUCCESS: Infrastructure applied"
      tofu output || true
  environment:
    name: production
  allow_failure: false

verify_k8s_infrastructure:
  stage: verify
  image: $K8S_RUNNER_IMAGE
  tags:
    - docker
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  needs:
    - apply_k8s_infrastructure
  script:
    - |
      mkdir -p ~/.kube
      
      cat > ~/.kube/config <<EOF
      apiVersion: v1
      kind: Config
      clusters:
      - cluster:
          certificate-authority-data: ${K8S_CA_CERT}
          server: ${K8S_HOST}
        name: k8s-cluster
      contexts:
      - context:
          cluster: k8s-cluster
          user: gitlab-ci
        name: gitlab-ci
      current-context: gitlab-ci
      users:
      - name: gitlab-ci
        user:
          token: ${K8S_TOKEN}
      EOF
      
      kubectl get namespaces || true
      kubectl get all -n pihole || true
      kubectl wait --for=condition=ready pod -l app=pihole -n pihole --timeout=300s || true
      kubectl get svc -n pihole || true
      
      echo "Verification complete"
      echo "Access: kubectl port-forward -n pihole svc/pihole-web 8080:80"
  allow_failure: true