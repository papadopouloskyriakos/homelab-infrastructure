***REMOVED***
# K8s Pipeline - Validation Only (Atlantis handles plan/apply)
***REMOVED***
# - GitLab CI: Format checking, validation, security scanning
# - Atlantis: Plan and Apply via MR comments (OpenTofu)
# - Argo CD: Auto-sync for argocd-apps/ manifests
# - State stored in GitLab Terraform backend
***REMOVED***

variables:
  K8S_DIR: "k8s"
  KUBE_CONTEXT: "infrastructure/nl/production:k8s-agent"

# -----------------------------------------------------------------------------
# Validate Stage - OpenTofu (runs on .tf file changes)
# -----------------------------------------------------------------------------
validate_k8s_opentofu:
  stage: validate
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        paths:
          - k8s/**/*.tf
          - k8s/**/*.tfvars
        compare_to: 'refs/heads/main'
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - k8s/**/*.tf
        - k8s/**/*.tfvars
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - cd "$K8S_DIR"
    
    # Format check
    - echo "=== Checking formatting ==="
    - tofu fmt -check -recursive . || { echo "WARNING - Run 'tofu fmt -recursive .' to fix formatting"; exit 1; }
    
    # Create temporary backend config for validation
    - echo "=== Initializing modules (validation mode) ==="
    - |
      cat > backend_override.tf << 'BACKEND'
      terraform {
        backend "local" {
          path = "/tmp/terraform.tfstate"
        }
      }
      BACKEND
    
    - tofu init -input=false -reconfigure
    
    # Validate syntax and module structure
    - echo "=== Validating configuration ==="
    - tofu validate
    
    # Clean up temp backend
    - rm -f backend_override.tf
    
    - echo "OK - OpenTofu validation passed - Atlantis will handle plan/apply in MR"
  allow_failure: false

# -----------------------------------------------------------------------------
# Validate Stage - Argo CD Manifests (runs on argocd-apps/ changes)
# -----------------------------------------------------------------------------
validate_argocd_manifests:
  stage: validate
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        paths:
          - k8s/argocd-apps/**/*.yaml
          - k8s/argocd-apps/**/*.yml
        compare_to: 'refs/heads/main'
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - k8s/argocd-apps/**/*.yaml
        - k8s/argocd-apps/**/*.yml
  before_script:
    - kubectl config use-context "$KUBE_CONTEXT"
  script:
    - echo "=== Validating Argo CD manifests ==="
    
    # Dry-run validation of all manifests
    - |
      for app_dir in k8s/argocd-apps/*/; do
        app_name=$(basename "$app_dir")
        echo "--- Validating $app_name ---"
        
        # Validate each YAML file (skip application.yaml - it's for Argo CD itself)
        for file in "$app_dir"*.yaml "$app_dir"*.yml; do
          [ -f "$file" ] || continue
          filename=$(basename "$file")
          
          if [ "$filename" = "application.yaml" ]; then
            echo "  SKIP - $filename (Argo CD Application resource)"
            continue
          fi
          
          echo "  VALIDATING - $filename"
          kubectl apply --dry-run=client -f "$file" 2>&1 || {
            echo "  FAILED - $file"
            exit 1
          }
        done
      done
    
    - echo "OK - Argo CD manifests valid"
  allow_failure: false

# -----------------------------------------------------------------------------
# Atlantis Skip - Provides passing status when no .tf changes
# -----------------------------------------------------------------------------
atlantis_not_required:
  stage: validate
  image: alpine:latest
  tags:
    - k8s
  rules:
    # Don't run if .tf files changed (Atlantis will handle those)
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        paths:
          - k8s/**/*.tf
          - k8s/**/*.tfvars
          - pve/**/*.tf
          - pve/**/*.tfvars
        compare_to: 'refs/heads/main'
      when: never
    # Run for all other MRs (docker, cisco, etc.)
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
  script:
    - echo "=============================================="
    - echo "No OpenTofu/Terraform changes detected"
    - echo "Atlantis plan/apply not required for this MR"
    - echo "=============================================="
    - echo ""
    - echo "This MR can be merged without Atlantis approval."
  allow_failure: false

# -----------------------------------------------------------------------------
# Deploy Stage - Bootstrap Argo CD Applications (runs after merge to main)
# -----------------------------------------------------------------------------
bootstrap_argocd_apps:
  stage: deploy
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - k8s/argocd-apps/**/*.yaml
        - k8s/argocd-apps/**/*.yml
  before_script:
    - kubectl config use-context "$KUBE_CONTEXT"
  script:
    - echo "=== Bootstrapping Argo CD Applications ==="
    
    # Apply all application.yaml files (idempotent - safe to re-apply existing apps)
    - |
      for app_dir in k8s/argocd-apps/*/; do
        app_file="${app_dir}application.yaml"
        if [ -f "$app_file" ]; then
          app_name=$(basename "$app_dir")
          echo "--- Applying $app_name ---"
          kubectl apply -f "$app_file"
        fi
      done
    
    - echo ""
    - echo "=== Argo CD Applications Status ==="
    - kubectl get applications -n argocd
  allow_failure: false

# -----------------------------------------------------------------------------
# Verify Stage - Runs after merge to main (post-Atlantis/Argo CD apply)
# -----------------------------------------------------------------------------
verify_k8s_infrastructure:
  stage: verify
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - k8s/**/*
  before_script:
    - kubectl config use-context "$KUBE_CONTEXT"
  script:
    - echo "=== Verifying K8s infrastructure (post-Atlantis/Argo CD apply) ==="
    
    # Cluster health
    - kubectl get nodes
    
    # Core infrastructure (Atlantis-managed)
    - echo "=== Core Infrastructure (Atlantis) ==="
    - kubectl get pods -n nfs-provisioner || true
    - kubectl get pods -n ingress-nginx || true
    - kubectl get pods -n REDACTED_01b50c5d || true
    - kubectl get pods -n argocd || true
    
    # Application workloads (Atlantis-managed)
    - echo "=== Application Namespaces (Atlantis) ==="
    - kubectl get pods -n awx || true
    - kubectl get pods -n minio || true
    - kubectl get pods -n monitoring || true
    - kubectl get pods -n pihole || true
    
    # Argo CD managed applications
    - echo "=== Argo CD Applications ==="
    - kubectl get applications -n argocd || true
    - kubectl get pods -n velero || true
    
    # Key services
    - echo "=== NodePort Services ==="
    - kubectl get svc -A | grep NodePort || true
    
    ***REMOVED***
    - echo "=== Storage ==="
    - kubectl get pvc -A
    - kubectl get sc
    
    - echo "OK - Verification complete"
  environment:
    name: production
    kubernetes:
      agent: k8s-agent
  allow_failure: true