***REMOVED***
# K8s Pipeline - Validation Only (Atlantis handles plan/apply)
***REMOVED***
# - GitLab CI: Format checking, validation, security scanning
# - Atlantis: Plan and Apply via MR comments
# - State stored in GitLab Terraform backend
***REMOVED***

variables:
  K8S_DIR: "k8s"
  KUBE_CONTEXT: "infrastructure/nl/production:k8s-agent"

# -----------------------------------------------------------------------------
# Validate Stage - Runs on every push to k8s/**
# -----------------------------------------------------------------------------
validate_k8s_manifests:
  stage: validate
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - changes:
        - k8s/**/*
      when: on_success
  before_script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
  script:
    - cd "$K8S_DIR"
    
    # Format check
    - echo "=== Checking formatting ==="
    - tofu fmt -check -recursive . || { echo "⚠️ Run 'tofu fmt -recursive .' to fix formatting"; exit 1; }
    
    # Create temporary backend config for validation
    - echo "=== Initializing modules (validation mode) ==="
    - |
      cat > backend_override.tf << 'BACKEND'
      terraform {
        backend "local" {
          path = "/tmp/terraform.tfstate"
        }
      }
      BACKEND
    
    - tofu init -input=false -reconfigure
    
    # Validate syntax and module structure
    - echo "=== Validating configuration ==="
    - tofu validate
    
    # Clean up temp backend
    - rm -f backend_override.tf
    
    - echo "✅ Validation passed - Atlantis will handle plan/apply in MR"
  allow_failure: false

# -----------------------------------------------------------------------------
# Verify Stage - Runs after merge to main (post-Atlantis apply)
# -----------------------------------------------------------------------------
verify_k8s_infrastructure:
  stage: verify
  image: $K8S_IMAGE
  tags:
    - k8s
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - k8s/**/*
      when: on_success
  before_script:
    - kubectl config use-context "$KUBE_CONTEXT"
  script:
    - echo "=== Verifying K8s infrastructure (post-Atlantis apply) ==="
    
    # Cluster health
    - kubectl get nodes
    
    # Core infrastructure
    - echo "=== Core Infrastructure ==="
    - kubectl get pods -n nfs-provisioner || true
    - kubectl get pods -n ingress-nginx || true
    - kubectl get pods -n REDACTED_01b50c5d || true
    
    # Application workloads
    - echo "=== Application Namespaces ==="
    - kubectl get pods -n awx || true
    - kubectl get pods -n minio || true
    - kubectl get pods -n monitoring || true
    - kubectl get pods -n pihole || true
    - kubectl get pods -n velero || true
    
    # Key services
    - echo "=== NodePort Services ==="
    - kubectl get svc -A | grep NodePort || true
    
    ***REMOVED***
    - echo "=== Storage ==="
    - kubectl get pvc -A
    - kubectl get sc
    
    - echo "✅ Verification complete"
  environment:
    name: production
    kubernetes:
      agent: k8s-agent
  allow_failure: true
